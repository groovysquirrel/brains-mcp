# LLM Gateway V2 Configuration Restructuring (04-04-2025)

## Overview
Today we restructured the LLM Gateway V2 configuration system to better support multiple providers, vendors, and models. The main goal was to separate provider-specific configurations from general model information and establish a clear hierarchy for configuration management.

## Changes Made

### 1. Directory Structure
```
config/
├── bedrock/
│   ├── models.json      # Bedrock-specific model configurations
│   ├── provider.json    # Bedrock provider settings
│   └── vendors/         # Vendor-specific configurations
│       ├── anthropic.json
│       ├── amazon.json
│       └── ...
└── README.md           # Configuration documentation
```

### 2. Type Definitions
- **ProviderConfig**: Provider-specific settings and capabilities
  - Removed model information
  - Added type, vendors list, and provider capabilities
  - Added operational settings (maxConcurrentRequests, requestTimeout)

- **VendorConfig**: Vendor-specific configurations
  - Added displayName and models list
  - Added vendor-specific capabilities
  - Retained prompt and response format settings

- **ModelConfig**: Model-specific information
  - Added inferenceTypes (onDemand/provisioned)
  - Added pricing information
  - Added contextWindow and version fields

## Design Decisions

1. **Separation of Concerns**
   - Provider configuration focuses on operational settings
   - Vendor configuration handles vendor-specific behavior
   - Model configuration contains model-specific details

2. **Configuration Hierarchy**
   - Provider → Vendor → Model
   - Each level has its own capabilities and settings
   - Clear inheritance path for settings

3. **Backward Compatibility**
   - Maintained existing field names where possible
   - Added new fields as optional to prevent breaking changes

## Lessons Learned

1. **Configuration Organization**
   - Keep provider settings focused on operational concerns
   - Avoid duplicating model information across files
   - Use clear naming conventions for configuration fields

2. **Type Safety**
   - Define comprehensive interfaces for all configuration types
   - Make optional fields explicit with '?' notation
   - Document field purposes with comments

3. **File Structure**
   - Group related configurations together
   - Use meaningful directory names
   - Keep configuration paths consistent

4. **Claude 3 Messages API Implementation**
   - Model ID Formatting:
     - Claude 3 models require specific ID format: `anthropic.claude-3-sonnet-20240229-v1:0`
     - Avoid double-prefixing model IDs (e.g., `anthropic.anthropic.claude-3...`)
     - Reference: [AWS Bedrock Claude 3 Documentation](https://docs.aws.amazon.com/bedrock/latest/userguide/model-parameters-claude.html)
   
   - API Format Selection:
     - Claude 3 models require Messages API format
     - Configuration must explicitly list models in `apiFormats.messages.models`
     - Reference: [AWS Bedrock Messages API](https://docs.aws.amazon.com/bedrock/latest/userguide/model-parameters-claude-messages.html)
   
   - Request Formatting:
     - Messages API requires specific structure:
       ```json
       {
         "messages": [
           {"role": "user", "content": "Hello"}
         ],
         "max_tokens": 4096,
         "temperature": 0.7,
         "top_p": 1,
         "anthropic_version": "bedrock-2023-05-31"
       }
       ```
     - Common errors to avoid:
       - Missing `messages` array
       - Using `max_tokens_to_sample` instead of `max_tokens`
       - Incorrect model ID format
     - Reference: [AWS Bedrock Runtime API](https://docs.aws.amazon.com/bedrock/latest/APIReference/API_runtime_InvokeModel.html)

## Known Issues

1. **Claude 3 Model ID Validation**
   - Error: `"claude-3-sonnet-20240229" is not supported on this API. Please use the Messages API instead.`
   - Solution: Ensure model ID includes full version and prefix: `anthropic.claude-3-sonnet-20240229-v1:0`

2. **Messages API Request Format**
   - Error: `Malformed input request: #: subject must not be valid against schema {"required":["messages"]}`
   - Solution: Always include `messages` array and remove `max_tokens_to_sample`

3. **API Format Detection**
   - Current implementation may incorrectly default to prompt API
   - Need to improve model ID matching in configuration

## Future Development Notes

1. **Registry Updates**
   - Update discovery script to handle new structure
   - Implement caching for vendor configurations
   - Add validation for configuration hierarchy

2. **Configuration Management**
   - Consider adding configuration versioning
   - Implement configuration migration tools
   - Add validation for required fields

3. **Documentation**
   - Add examples for each configuration type
   - Document configuration update process
   - Create configuration troubleshooting guide

4. **Testing**
   - Add tests for configuration loading
   - Validate configuration inheritance
   - Test backward compatibility

5. **Claude 3 Support**
   - Add comprehensive tests for Messages API
   - Implement better error handling for API format mismatches
   - Create migration guide for Claude 2 to Claude 3

## Action Items

1. [ ] Update discovery script
2. [ ] Add configuration validation
3. [ ] Create migration tools
4. [ ] Update documentation
5. [ ] Add test coverage
6. [ ] Fix Claude 3 Messages API implementation
7. [ ] Add validation for model ID formats
8. [ ] Improve API format detection

## Migration Guide

For teams updating to the new configuration structure:

1. Move provider-specific settings to `provider.json`
2. Create vendor configurations in `vendors/`
3. Update model configurations to include new fields
4. Test configuration loading and validation
5. Update any custom scripts that interact with configurations

## Implementation Details

### BedrockProvider Updates
1. **Vendor-Specific Request Formatting**
   - Anthropic: Uses `max_tokens` for Claude 3, `max_tokens_to_sample` for older models
   - Meta: Uses `max_gen_len` for token limits
   - Mistral: Uses `max_tokens` and `stop` array

2. **Configuration Handling**
   - Provider settings now include defaultSettings for common parameters
   - Settings cascade: request → provider defaults → hardcoded defaults
   - Improved error handling with structured logging

3. **Type Safety Improvements**
   - Added interfaces for vendor-specific requests
   - Updated GatewayRequest to include all necessary fields
   - Fixed logger visibility to match base class

4. **Known Issues & Solutions**
   - Fixed validation error for Anthropic's required `max_tokens_to_sample`
   - Addressed type mismatches in configuration interfaces
   - Improved error messages for malformed requests

### Next Steps
1. [ ] Add vendor-specific prompt formatting
2. [ ] Implement response streaming improvements
3. [ ] Add configuration validation for vendor-specific fields
4. [ ] Create examples for each vendor's request format
5. [ ] Fix Claude 3 Messages API implementation
6. [ ] Add comprehensive error handling for API format mismatches
